<!DOCTYPE html>
<html lang="en-US">
<!-- Simple index.html with in-browser jsx compilation -->
<head>
<title>App</title>
<script src="https://unpkg.com/lodash@4.17.21" crossorigin></script>
<script src="https://unpkg.com/react@16/umd/react.development.js" crossorigin></script>
<script src="https://unpkg.com/react-bootstrap@1.5.2/dist/react-bootstrap.js" crossorigin></script>
<script src="https://unpkg.com/react-router-dom@5.2.0/umd/react-router-dom.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone@7.20.12/babel.js"></script>
<!-- Useful things
https://github.com/johndiiorio/react-useinterval/blob/master/src/index.tsx
https://github.com/dance2die/react-use-localstorage/blob/master/src/index.ts
-->
<!-- no 404 request for icon -->
<link rel="shortcut icon" href="data:image/x-icon;," type="image/x-icon">
<link href="https://getbootstrap.com/docs/4.6/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<style>
</style>
</head>
<body>
<div id="app"></div>
<script type="text/babel">
const { useState, useEffect, useRef } = React;
const { HashRouter, Link, Route, useRouteMatch } = ReactRouterDOM;
const { Dropdown } = ReactBootstrap;

const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

function createReverbImpulse(seconds, decay) {
    const rate = audioCtx.sampleRate;
    const length = Math.max(1, Math.floor(seconds * rate));
    const impulse = audioCtx.createBuffer(2, length, rate);
    for (let ch = 0; ch < impulse.numberOfChannels; ch++) {
        const channelData = impulse.getChannelData(ch);
        for (let i = 0; i < length; i++) {
            const t = i / length;
            channelData[i] = (Math.random() * 2 - 1) * Math.pow(1 - t, decay);
        }
    }
    return impulse;
}

function createCompressor() {
    const compressor = audioCtx.createDynamicsCompressor();
    compressor.threshold.value = -24;  // Start compressing at -24dB
    compressor.knee.value = 30;        // Smooth compression curve
    compressor.ratio.value = 12;       // Strong compression (12:1)
    compressor.attack.value = 0.003;   // Fast attack (3ms)
    compressor.release.value = 0.25;   // Medium release (250ms)
    return compressor;
}

const compressor = createCompressor();
compressor.connect(audioCtx.destination);

function createInstrumentRootNode(config) {
    const masterGain = audioCtx.createGain();
    masterGain.gain.value = config.volume || 1.0;

    const dryGain = audioCtx.createGain();
    dryGain.gain.value = config.dryMix || 0.9;
    dryGain.connect(masterGain);

    const wetGain = audioCtx.createGain();
    wetGain.gain.value = config.wetMix || 0.2;
    wetGain.connect(masterGain);

    const reverbNode = audioCtx.createGain();
    reverbNode.connect(wetGain);

    const convolver = audioCtx.createConvolver();
    convolver.buffer = createReverbImpulse(config.reverb.seconds || 3, config.reverb.decay || 2);
    reverbNode.connect(convolver);
    convolver.connect(wetGain);

    return { masterGain, dryGain, wetGain, reverbNode, convolver };
}

class NoteInstrument {
    constructor() {
        this.rootNode = createInstrumentRootNode({
            volume: 0.7,
            dryMix: 0.8,
            wetMix: 0.3,
            reverb: { seconds: 2, decay: 2 }
        });
        this.rootNode.masterGain.connect(compressor);
        this.noteOscs = {};
        this.envelope = {
            attack: 0.01,
            decay: 0.2,
            sustain: 0.7,
            release: 0.5
        };
    }

    setAttack(value) {
        this.envelope.attack = value;
    }

    setDecay(value) {
        this.envelope.decay = value;
    }

    setSustain(value) {
        this.envelope.sustain = value;
    }

    setRelease(value) {
        this.envelope.release = value;
    }

    setVolume(value) {
        this.rootNode.masterGain.gain.setValueAtTime(value, audioCtx.currentTime);
    }

    setReverbMix(value) {
        this.rootNode.wetGain.gain.setValueAtTime(value, audioCtx.currentTime);
        this.rootNode.dryGain.gain.setValueAtTime(1.0 - value, audioCtx.currentTime);
    }

    setReverbTime(seconds, decay) {
        const convolver = this.rootNode.convolver;
        convolver.buffer = createReverbImpulse(seconds, decay);
    }

    startNote(note, velocity = 1.0) {
        if (this.noteOscs[note]) {
            const existing = this.noteOscs[note];
            existing.gainNode.gain.cancelScheduledValues(audioCtx.currentTime);
            existing.gainNode.gain.setValueAtTime(existing.gainNode.gain.value, audioCtx.currentTime);
            existing.gainNode.gain.linearRampToValueAtTime(0, audioCtx.currentTime + this.envelope.release);
            return;
        }
        const osc = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();

        osc.type = 'custom';
        osc.setPeriodicWave(audioCtx.createPeriodicWave(
            new Float32Array([0, 0, 0, 0, 0]),
            new Float32Array([1, 0.5, 0.25, 0.125, 0.0625])
        ));
        osc.frequency.value = 440 * Math.pow(2, (note - 69) / 12); // MIDI note to frequency

        const now = audioCtx.currentTime;
        gainNode.gain.setValueAtTime(0, now);
        gainNode.gain.linearRampToValueAtTime(velocity, now + this.envelope.attack);
        gainNode.gain.linearRampToValueAtTime(velocity * this.envelope.sustain, now + this.envelope.attack + this.envelope.decay);

        osc.connect(gainNode);
        gainNode.connect(this.rootNode.dryGain);
        gainNode.connect(this.rootNode.reverbNode);

        osc.start();
        this.noteOscs[note] = { osc, gainNode };
    }

    stopNote(note) {
        const existing = this.noteOscs[note];
        if (existing) {
            const now = audioCtx.currentTime;
            existing.gainNode.gain.cancelScheduledValues(now);
            existing.gainNode.gain.setValueAtTime(existing.gainNode.gain.value, now);
            existing.gainNode.gain.linearRampToValueAtTime(0, now + this.envelope.release);
        }
    }
}

const app = document.getElementById("app");

const instrument = new NoteInstrument();

function App() {
    /*
    Controls:
    - Turn On button: resumes audio context
    - MIDI device selector
    - envelope controls: attack, decay, sustain, release
    - reverb mix slider
    - reverb time and decay controls
    */

  const [isAudioOn, setIsAudioOn] = useState(audioCtx.state === "running");
  const [attack, setAttack] = useState(0.01);
  const [decay, setDecay] = useState(0.2);
  const [sustain, setSustain] = useState(0.7);
  const [release, setRelease] = useState(0.5);
  const [volume, setVolume] = useState(0.7);
  const [reverbMix, setReverbMix] = useState(0.3);
  const [reverbTime, setReverbTime] = useState(2);
  const [reverbDecay, setReverbDecay] = useState(2);

  const handleTurnOn = async () => {
      if (audioCtx.state !== "running") {
          await audioCtx.resume();
      }
      setIsAudioOn(audioCtx.state === "running");
  };


  const handleAttack = (e) => {
      const value = Number(e.target.value);
      setAttack(value);
      instrument.setAttack(value);
  };

  const handleDecay = (e) => {
      const value = Number(e.target.value);
      setDecay(value);
      instrument.setDecay(value);
  };

  const handleSustain = (e) => {
      const value = Number(e.target.value);
      setSustain(value);
      instrument.setSustain(value);
  };

  const handleRelease = (e) => {
      const value = Number(e.target.value);
      setRelease(value);
      instrument.setRelease(value);
  };

  const handleVolume = (e) => {
      const value = Number(e.target.value);
      setVolume(value);
      instrument.setVolume(value);
  };

  const handleReverbMix = (e) => {
      const value = Number(e.target.value);
      setReverbMix(value);
      instrument.setReverbMix(value);
  };

  const handleReverbTime = (e) => {
      const value = Number(e.target.value);
      setReverbTime(value);
      instrument.setReverbTime(value, reverbDecay);
  };

  const handleReverbDecay = (e) => {
      const value = Number(e.target.value);
      setReverbDecay(value);
      instrument.setReverbTime(reverbTime, value);
  };

  return (
    <div className="container py-4">
        <div className="d-flex align-items-center justify-content-between mb-3">
            <h1 className="h3 mb-0">React Audio Instrument</h1>
            <button className={`btn ${isAudioOn ? "btn-success" : "btn-primary"}`} onClick={handleTurnOn}>
                {isAudioOn ? "Audio On" : "Turn On"}
            </button>
        </div>

        <div className="card mb-3">
            <div className="card-body">
                <div className="form-group mb-3">
                    <label className="form-label">Midi Device (not connected)</label>
                    <select className="form-control" onChange={e => { e.persist(); console.log(e); }}>
                        <option>None</option>
                        <option>All</option>
                    </select>
                </div>

                <div className="row">
                    <div className="col-md-6">
                        <h2 className="h5">Envelope</h2>
                        <div className="form-group mb-3">
                            <label className="form-label">Attack: {attack.toFixed(3)}s</label>
                            <input type="range" min="0.001" max="1" step="0.001" value={attack} onChange={handleAttack} className="form-control-range" />
                        </div>
                        <div className="form-group mb-3">
                            <label className="form-label">Decay: {decay.toFixed(3)}s</label>
                            <input type="range" min="0.001" max="2" step="0.001" value={decay} onChange={handleDecay} className="form-control-range" />
                        </div>
                        <div className="form-group mb-3">
                            <label className="form-label">Sustain: {sustain.toFixed(2)}</label>
                            <input type="range" min="0" max="1" step="0.01" value={sustain} onChange={handleSustain} className="form-control-range" />
                        </div>
                        <div className="form-group mb-3">
                            <label className="form-label">Release: {release.toFixed(3)}s</label>
                            <input type="range" min="0.001" max="2" step="0.001" value={release} onChange={handleRelease} className="form-control-range" />
                        </div>
                    </div>
                    <div className="col-md-6">
                        <h2 className="h5">Output</h2>
                        <div className="form-group mb-3">
                            <label className="form-label">Volume: {volume.toFixed(2)}</label>
                            <input type="range" min="0" max="1" step="0.01" value={volume} onChange={handleVolume} className="form-control-range" />
                        </div>
                        <div className="form-group mb-3">
                            <label className="form-label">Reverb Mix: {reverbMix.toFixed(2)}</label>
                            <input type="range" min="0" max="1" step="0.01" value={reverbMix} onChange={handleReverbMix} className="form-control-range" />
                        </div>
                        <div className="form-group mb-3">
                            <label className="form-label">Reverb Time: {reverbTime.toFixed(2)}s</label>
                            <input type="range" min="0.1" max="6" step="0.1" value={reverbTime} onChange={handleReverbTime} className="form-control-range" />
                        </div>
                        <div className="form-group mb-3">
                            <label className="form-label">Reverb Decay: {reverbDecay.toFixed(2)}</label>
                            <input type="range" min="0.5" max="6" step="0.1" value={reverbDecay} onChange={handleReverbDecay} className="form-control-range" />
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
  )
}
ReactDOM.render(React.createElement(App), document.getElementById("app"))
</script>
</body>
</html>
